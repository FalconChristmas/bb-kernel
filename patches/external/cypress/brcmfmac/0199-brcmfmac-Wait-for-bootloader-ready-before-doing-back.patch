From 96fd6b0c952be2f54e6aeb6d9348c31aa70870c7 Mon Sep 17 00:00:00 2001
From: avishad verma <avishad.verma@infineon.com>
Date: Mon, 10 Oct 2022 06:44:09 -0500
Subject: [PATCH 199/208] brcmfmac: Wait for bootloader ready before doing
 backplane access

Fixes: SWWLAN-144484

Signed-off-by: Avishad Verma avishad.verma@infineon.com
---
 .../net/wireless/broadcom/brcm80211/brcmfmac/sdio.c  | 12 ++++++++++++
 1 file changed, 12 insertions(+)

diff --git a/drivers/net/wireless/broadcom/brcm80211/brcmfmac/sdio.c b/drivers/net/wireless/broadcom/brcm80211/brcmfmac/sdio.c
index cf380433e171..1f47175482c0 100644
--- a/drivers/net/wireless/broadcom/brcm80211/brcmfmac/sdio.c
+++ b/drivers/net/wireless/broadcom/brcm80211/brcmfmac/sdio.c
@@ -4488,6 +4488,7 @@ brcmf_sdio_buscore_sec_attach(void *ctx, struct brcmf_blhs **blhs, struct brcmf_
 	struct brcmf_blhs *blhsh = NULL;
 	struct brcmf_ccsec *ccsech = NULL;
 	u32 reg_addr;
+	u32 regdata;
 	u8 cardcap;
 
 	if (sdiodev->func1->vendor != SDIO_VENDOR_ID_CYPRESS)
@@ -4504,6 +4505,17 @@ brcmf_sdio_buscore_sec_attach(void *ctx, struct brcmf_blhs **blhs, struct brcmf_
 		blhsh->read = brcmf_sdio_buscore_blhs_read;
 		blhsh->write = brcmf_sdio_buscore_blhs_write;
 
+		blhsh->write(ctx, blhsh->h2d, 0);
+
+		SPINWAIT_MS((blhsh->read(ctx, blhsh->d2h) & flag) == 0,
+			    timeout, interval);
+
+		regdata = blhsh->read(ctx, blhsh->d2h);
+		if (!(regdata & flag)) {
+			brcmf_err("Timeout waiting for bootloader ready\n");
+			kfree(blhsh);
+			return -EPERM;
+		}
 		*blhs = blhsh;
 	}
 
-- 
2.17.1


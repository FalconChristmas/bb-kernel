From 314e40aa1c001617680862511713fa48ae31fb2f Mon Sep 17 00:00:00 2001
From: avishad verma <avishad.verma@infineon.com>
Date: Thu, 29 Sep 2022 03:40:34 -0500
Subject: [PATCH 198/208] brcmfmac: SDIO Rev31 changes in rmmod sequence


Signed-off-by: Shelley Yang <shelley.yang@infineon.com>
---
 .../broadcom/brcm80211/brcmfmac/sdio.c        | 33 +++++++++++++++++--
 .../broadcom/brcm80211/brcmfmac/sdio.h        |  4 +++
 2 files changed, 34 insertions(+), 3 deletions(-)

diff --git a/drivers/net/wireless/broadcom/brcm80211/brcmfmac/sdio.c b/drivers/net/wireless/broadcom/brcm80211/brcmfmac/sdio.c
index 9f1822784f53..cf380433e171 100644
--- a/drivers/net/wireless/broadcom/brcm80211/brcmfmac/sdio.c
+++ b/drivers/net/wireless/broadcom/brcm80211/brcmfmac/sdio.c
@@ -5335,10 +5335,37 @@ void brcmf_sdio_remove(struct brcmf_sdio *bus)
 
 				if (bus->ci->blhs)
 					bus->ci->blhs->init(bus->ci);
-				/* Reset the PMU, backplane and all the
-				 * cores by using the PMUWatchdogCounter.
+
+				/* Configure registers to trigger WLAN reset on
+				 * "SDIO Soft Reset", and set RES bit to trigger
+				 *  SDIO as well as WLAN reset
+				 * (instead of using PMU/CC Watchdog register)
 				 */
-				brcmf_chip_reset_watchdog(bus->ci);
+				if (bus->ci->ccsec) {
+					struct brcmf_sdio_dev *sdiodev;
+					int err = 0;
+					u32 reg_val = 0;
+
+					sdiodev = bus->sdiodev;
+					/* Set card control so an SDIO card reset
+					 *does a WLAN backplane reset */
+					reg_val = brcmf_sdiod_func0_rb(sdiodev,
+								       SDIO_CCCR_BRCM_CARDCTRL,
+								       &err);
+					reg_val |= SDIO_CCCR_BRCM_CARDCTRL_WLANRESET;
+
+					brcmf_sdiod_func0_wb(sdiodev, SDIO_CCCR_BRCM_CARDCTRL,
+							     reg_val, &err);
+					brcmf_sdiod_func0_wb(sdiodev, SDIO_CCCR_ABORT,
+							    sdiodev->func1->num |\
+								SDIO_IO_CARD_RESET,
+								NULL);
+				} else {
+					/* Reset the PMU, backplane and all the
+					 * cores by using the PMUWatchdogCounter.
+					 */
+					brcmf_chip_reset_watchdog(bus->ci);
+				}
 				if (bus->ci->blhs)
 					bus->ci->blhs->post_wdreset(bus->ci);
 
diff --git a/drivers/net/wireless/broadcom/brcm80211/brcmfmac/sdio.h b/drivers/net/wireless/broadcom/brcm80211/brcmfmac/sdio.h
index e6c310a4e998..d3ae5b9cba39 100644
--- a/drivers/net/wireless/broadcom/brcm80211/brcmfmac/sdio.h
+++ b/drivers/net/wireless/broadcom/brcm80211/brcmfmac/sdio.h
@@ -127,6 +127,10 @@
 #define SBSDIO_FUNC1_MISC_REG_START	0x10000	/* f1 misc register start */
 #define SBSDIO_FUNC1_MISC_REG_LIMIT	0x1001F	/* f1 misc register end */
 
+/* Sdio Core Rev 31 */
+/* Hard Reset SDIO core, output soft reset signal which should cause backplane reset */
+#define SDIO_IO_CARD_RESET                0x08
+
 /* function 1 OCP space */
 
 /* sb offset addr is <= 15 bits, 32k */
-- 
2.17.1

